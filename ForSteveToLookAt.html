<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Google Places API</title>
    <script src="https://www.gstatic.com/firebasejs/3.7.1/firebase.js"></script>
</head>
<style>
/* Always set the map height explicitly to define the size of the div
       * element that contains the map. */

#map {
    height: 100%;
}


/* Optional: Makes the sample page fill the window. */

html,
body {
    height: 100%;
    margin: 0;
    padding: 0;
}
</style>

<body>
    <div id="placesDiv"></div>
    <div id="map"></div>
    <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDOa9CGHeiU2rtN2zI759DmUhBLExpv63k&libraries=places&callback=initMap" async defer></script>
    <script type="text/javascript">

        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyDWkiAd8yhcL7aCwkgDftkcd2Er3LduRT8",
            authDomain: "doghouse-eedd3.firebaseapp.com",
            databaseURL: "https://doghouse-eedd3.firebaseio.com",
            projectId: "doghouse-eedd3",
            storageBucket: "doghouse-eedd3.appspot.com",
            messagingSenderId: "1011871359407"
        };
        firebase.initializeApp(config);
        var database = firebase.database();
        database.ref().set({}); 

        var places = [];


        var queryURL = "https://maps.googleapis.com/maps/api/place/textsearch/json?query=best+burger+in+dallas&key=AIzaSyDOa9CGHeiU2rtN2zI759DmUhBLExpv63k";

        $.ajax({
            url: queryURL,
            type: "GET",
            contentType: 'text/plain',
            crossDomain: true,
            dataType: 'json',
            xhrFields: {
                // The 'xhrFields' property sets additional fields on the XMLHttpRequest.
                // This can be used to set the 'withCredentials' property.
                // Set the value to 'true' if you'd like to pass cookies to the server.
                // If this is enabled, your server must respond with the header
                // 'Access-Control-Allow-Credentials: true'.
                withCredentials: false
            }
            // ,
            //   headers: {
            //     // Set any custom headers here.
            //     // If you set any non-simple headers, your server must include these
            //     // headers in the 'Access-Control-Allow-Headers' response header.
            //   },        
        }).done(function(response) {
            //$('#test').text(JSON.stringify(response));
            //console.log(JSON.stringify(response));
            // console.log(response);

            for (i = 0; i < response.results.length; i++) {
                var resp = response.results[i];
                var placeObj = {
                    id: i,
                    
                    name: resp.name,
                    address: resp.formatted_address,
                    icon: resp.icon,
                    placeId: resp.place_id,
                    lat: resp.geometry.location.lat,
                    long: resp.geometry.location.lng,
                    // rating: resp.price_level,
                    // priceLevel: resp.rating
                };

                places.push(placeObj);

                // console.log(places);
            }

            for (var i = 0; i < places.length; i++) {
                database.ref('restaurants').push(places[i]);
            }

            var placeCount = places.length - 1;
            var randomNumber = Math.floor((Math.random() * placeCount) + 1);
            var plDiv = $('#placesDiv');
            var txt = "<p>" + places[randomNumber].name + "</p>" + 
            "<p>" + places[randomNumber].address + "</p>";
            plDiv.append(txt);

            //<button data-value="1" class="up-vote">Up</button>
            var newButton = $("<button>");
            newButton.text('Up');
            newButton.attr('data-value', places[randomNumber].id);
            newButton.attr('class', 'up-vote');
            plDiv.append(newButton);

        });


        $(document).on("click", ".up-vote", function() {
            var that = this;
            database.ref('restaurants').on('value', function(snapshot) {
               
                var other = that;
                snapshot.forEach(function(snap) {
                    // console.log(snap.val().name);
                        
                    if (snap.val().id == parseInt($(other).attr('data-value'))) {
                        console.log(snap.val().id);

                    }
                });
            }); 
        });

        // This example requires the Places library. Include the libraries=places
        // parameter when you first load the API. For example:
        // <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places">

        var map;
        var infowindow;

        function initMap() {
            var dallas = {
                lat: 32.7767,
                lng: -96.7970
            };

            map = new google.maps.Map(document.getElementById('map'), {
                center: dallas,
                zoom: 15
            });

            infowindow = new google.maps.InfoWindow();
            var service = new google.maps.places.PlacesService(map);
            service.nearbySearch({
                location: dallas,
                radius: 500,
                type: ['restaurant'],
                keyword: 'burger'
            }, callback);
        }

        function callback(results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                for (var i = 0; i < results.length; i++) {
                    createMarker(results[i]);
                }
            }
        }

        function createMarker(place) {
            var placeLoc = place.geometry.location;
            var marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location
            });

            google.maps.event.addListener(marker, 'click', function() {
                infowindow.setContent(place.name);
                infowindow.open(map, this);
            });
        }



    </script>
</body>

</html>
<!--
// $.ajax({

//   // The 'type' property sets the HTTP method.
//   // A value of 'PUT' or 'DELETE' will trigger a preflight request.
//   type: 'GET',

//   // The URL to make the request to.
//   url: 'http://html5rocks-cors.s3-website-us-east-1.amazonaws.com/index.html',

//   // The 'contentType' property sets the 'Content-Type' header.
//   // The JQuery default for this property is
//   // 'application/x-www-form-urlencoded; charset=UTF-8', which does not trigger
//   // a preflight. If you set this value to anything other than
//   // application/x-www-form-urlencoded, multipart/form-data, or text/plain,
//   // you will trigger a preflight request.
//   contentType: 'text/plain',

//   xhrFields: {
//     // The 'xhrFields' property sets additional fields on the XMLHttpRequest.
//     // This can be used to set the 'withCredentials' property.
//     // Set the value to 'true' if you'd like to pass cookies to the server.
//     // If this is enabled, your server must respond with the header
//     // 'Access-Control-Allow-Credentials: true'.
//     withCredentials: false
//   },

//   headers: {
//     // Set any custom headers here.
//     // If you set any non-simple headers, your server must include these
//     // headers in the 'Access-Control-Allow-Headers' response header.
//   },

//   success: function() {
//     // Here's where you handle a successful response.
//   },

//   error: function() {
//     // Here's where you handle an error response.
//     // Note that if the error was due to a CORS issue,
//     // this function will still fire, but there won't be any additional
//     // information about the error.
//   }
// });
-->
